# This file contains common pin mappings for the BIGTREETECH Manta M8P V2.0
# To use this config, the firmware should be compiled for the
# STM32H723 with a "128KiB bootloader" "25 MHz crystal"
# and "USB (on PA11/PA12)", "CAN bus (on PD0/PD1)" or Serial (on USART1 PA10/PA9).

# See docs/Config_Reference.md for a description of parameters.
[include mainsail.cfg]



[mcu]
# serial: /dev/serial/by-id/usb-Klipper_Klipper_firmware_12345-if00
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_1E0027000851313339373836-if00

[printer]
max_velocity: 250
max_accel: 3000
max_z_velocity: 20
max_z_accel: 150
square_corner_velocity: 5
kinematics: cartesian


[force_move]
enable_force_move: true

[extruder]
control = pid
pid_kp = 33.479
pid_ki = 3.720
pid_kd = 75.329
step_pin: PC7     # M8
dir_pin: !PC8     # M8
enable_pin: !PD2  # M8
gear_ratio: 1:1
microsteps: 16
rotation_distance: 7.596
#max_power: 1.0
nozzle_diameter: 0.6
filament_diameter: 1.75
heater_pin: PA1 # HE1
sensor_type: Generic 3950
sensor_pin: PB0 # TH0
min_temp: 10
max_temp: 300
min_extrude_temp: 189
max_extrude_only_distance: 200

[heater_bed]
heater_pin: PA0 # HE0
sensor_type: EPCOS 100K B57560G104F # Creality bed thermistor
sensor_pin: PB1 # THB
min_temp: 0
max_temp: 120
control: pid
pid_Kp: 68.701
pid_Ki: 0.869
pid_Kd: 1357.697


[probe_as_z_home]
#g28_probe_cmd_args: SAMPLES_TOLERANCE_RETRIES=5 SAMPLES=1


[safe_z_home]
speed: 250
z_hop: 10
z_hop_speed: 20
home_xy_position: 170,175

#-------------------------------------
# Bed Leveling
#-------------------------------------

[bltouch]
sensor_pin: ^PD13 # M3-Stop
control_pin: PD12 # Probe
pin_move_time: 0.675
stow_on_each_sample: False
probe_with_touch_mode: True
pin_up_touch_mode_reports_triggered: False
speed: 10
lift_speed: 15
samples: 5
samples_trunc_count: 2
samples_result: average
sample_retract_dist: 2
samples_tolerance: 0.0075
samples_tolerance_retries: 50
# X and Y offsets were measured using layout fluid (nozzle first)
# Original Microswiss NG Revo Shroud
#x_offset: -42.5
#y_offset: -14
# Dual 5015 Microswiss NG Revo Shroud
x_offset: -19
y_offset: -50

# Cura offset
# Original Microswiss NG Revo Shroud
#z_offset: 2.73
# Dual 5015 Microswiss NG Revo Shroud
z_offset: 1.6


[homing_heaters]
steppers: stepper_z
heaters: extruder, heater_bed

[bed_mesh]
zero_reference_position: 170,175
speed: 175
horizontal_move_z: 4
#probe_count: 41, 45 # (/40 = 7.5mm spacing, /44 = 7.5mm spacing)
probe_count: 21, 23 # (/20 = 15mm spacing, /22 = 15mm spacing)
mesh_pps: 5, 5
algorithm: bicubic
# # Range: 300 X, 330 Y 
# mesh_min: 15, 15
# mesh_max: 315, 345
# Range: 295 X, 325 Y 
mesh_min: 0, 0
mesh_max: 321, 300


# Maximum possible boundaries (have not checked min)
# mesh_min: 10, 10
# mesh_max: 315, 345

[bed_mesh pei]
version = 1
points =
	  0.013056, -0.003611, 0.034723, 0.051806, 0.013473, -0.024027, -0.011527, 0.097639, 0.110139, 0.070973, 0.035139, 0.073473, 0.075139, 0.083889, -0.003611, -0.009861, -0.001111, -0.058194, -0.095277, -0.158194, -0.053611
	  0.009723, -0.006111, -0.013611, 0.071389, 0.052639, -0.005277, 0.067223, 0.099723, 0.119723, 0.088056, -0.036111, 0.066389, 0.092639, 0.086389, 0.059723, 0.066806, 0.057223, -0.042777, -0.091944, -0.111527, 0.023056
	  0.044306, -0.032361, -0.044027, 0.087639, 0.109306, 0.008889, 0.061389, 0.105556, 0.068889, 0.034306, -0.025277, 0.008473, 0.045973, 0.065556, 0.011806, -0.020694, -0.006111, -0.035277, -0.064861, -0.084444, 0.001806
	  -0.019861, -0.076944, -0.043194, -0.011944, -0.019444, -0.058194, -0.052777, -0.001527, -0.013194, -0.003194, -0.061527, -0.034861, 0.000139, 0.068473, 0.007639, -0.013611, 0.084306, -0.015277, -0.036527, -0.068194, 0.088889
	  -0.012777, -0.057777, -0.049444, 0.004306, -0.034027, -0.038194, -0.054444, 0.022223, 0.014306, -0.012361, -0.059027, -0.009861, 0.023056, 0.011806, -0.015694, -0.009444, -0.006527, -0.026111, -0.049444, -0.066944, 0.085139
	  -0.008611, -0.061944, -0.051111, -0.026111, -0.016111, -0.054444, -0.043611, -0.008611, -0.011111, -0.013194, -0.034861, -0.007361, 0.024306, 0.063473, -0.014027, 0.006806, 0.017639, -0.008194, -0.029444, -0.070277, 0.065139
	  0.007223, -0.034027, -0.004861, 0.012223, -0.030277, -0.050277, -0.044444, -0.017361, 0.007223, -0.022361, -0.031944, -0.010277, 0.017639, 0.032223, 0.018473, -0.015277, 0.029723, -0.013194, -0.019861, -0.065694, 0.050973
	  0.021806, -0.033611, -0.007777, -0.017777, 0.000973, -0.041111, -0.052361, -0.034027, -0.005277, -0.009861, -0.051527, -0.007777, 0.026389, 0.036389, -0.009861, -0.011944, 0.016389, -0.004861, -0.047777, -0.058611, 0.052639
	  0.037639, 0.012639, 0.003056, -0.003611, -0.016944, -0.058194, -0.047777, -0.027777, -0.026111, -0.016944, -0.037361, -0.003194, 0.016806, 0.026806, -0.017361, -0.005277, 0.018473, -0.005277, -0.034027, -0.078611, 0.020973
	  0.057223, -0.032777, -0.021111, -0.019444, -0.039027, -0.074027, -0.055277, -0.011111, -0.007777, -0.026944, -0.033194, 0.001389, 0.044306, 0.032639, 0.010139, -0.004444, 0.010556, -0.006527, -0.030277, -0.080694, 0.047223
	  0.036389, -0.033194, -0.018611, -0.013194, -0.049027, -0.064444, -0.059444, -0.021527, -0.006111, -0.015694, -0.034444, -0.015277, 0.044723, 0.019723, 0.005556, 0.007223, 0.024723, -0.010277, -0.045277, -0.085694, 0.020139
	  0.070973, -0.009444, 0.008889, 0.002639, -0.022361, -0.049861, -0.043611, 0.012639, 0.005139, -0.006944, -0.034444, 0.002639, 0.056389, 0.048473, 0.019723, 0.010139, 0.021806, -0.019444, -0.056944, -0.076944, 0.011389
	  0.087639, 0.001389, -0.001944, -0.006944, 0.010139, -0.024444, -0.033611, 0.011806, 0.011389, 0.008056, -0.008194, 0.027639, 0.054306, 0.052639, 0.018473, 0.020556, 0.015973, 0.010139, -0.025694, -0.071944, 0.029723
	  0.062223, -0.000277, 0.002639, 0.012223, -0.022361, -0.029027, -0.044027, -0.000277, 0.034723, 0.015556, -0.022777, 0.013889, 0.056806, 0.046389, 0.000556, 0.001806, 0.017639, -0.016111, -0.058611, -0.102777, 0.011389
	  0.083056, 0.024306, 0.024723, 0.007223, -0.024444, -0.046111, -0.035277, -0.001944, -0.003611, 0.016806, -0.039027, -0.000277, 0.057639, 0.038473, 0.011389, -0.003611, 0.019306, -0.018194, -0.040277, -0.117361, -0.002361
	  0.061806, 0.012639, -0.001111, 0.002223, -0.036111, -0.048611, -0.057361, -0.005694, -0.014444, 0.000556, -0.039444, -0.001111, 0.035556, 0.023056, 0.009306, -0.006527, 0.020973, -0.018611, -0.064444, -0.092777, 0.005973
	  0.096389, 0.011806, 0.013473, 0.030139, -0.009444, -0.061944, -0.051527, -0.004027, -0.002777, 0.003056, -0.021944, 0.014723, 0.043473, 0.045556, 0.015139, 0.016806, 0.015139, -0.004444, -0.060277, -0.090277, 0.033889
	  0.098473, 0.014306, 0.012223, -0.013611, -0.035277, -0.071527, -0.069027, -0.025277, -0.004444, -0.005277, -0.037777, 0.005556, 0.037223, 0.030556, 0.000556, -0.023194, 0.017223, 0.001806, -0.049027, -0.109444, 0.017223
	  0.113473, 0.012223, 0.018473, -0.005277, -0.022361, -0.053611, -0.073194, -0.031111, -0.018194, -0.031111, -0.024444, 0.019306, 0.038473, 0.034723, 0.013889, -0.001527, 0.034306, -0.024444, -0.046111, -0.096944, 0.018889
	  0.115556, -0.004861, 0.033056, -0.002361, -0.008611, -0.078194, -0.057777, -0.024444, -0.031111, -0.029027, -0.039444, 0.002639, 0.024723, 0.042223, -0.034027, -0.004861, 0.013473, -0.024027, -0.048611, -0.094027, 0.006806
	  0.107223, 0.034723, 0.011806, 0.015973, 0.009306, -0.069861, -0.072361, -0.018194, 0.062223, 0.005556, -0.045277, -0.021527, 0.027639, 0.012223, -0.019444, -0.036944, -0.011944, -0.037777, -0.072361, -0.112777, -0.005277
	  0.086389, -0.003194, 0.011389, 0.019723, -0.038194, -0.070694, -0.089861, -0.028194, -0.009444, -0.020277, -0.015694, 0.005556, 0.019306, 0.018056, -0.014027, -0.044444, -0.003611, -0.040277, -0.059027, -0.131527, 0.003473
	  0.116389, 0.010973, 0.024723, -0.012777, -0.036944, -0.058611, -0.061944, -0.006944, 0.010973, 0.013889, -0.062361, -0.014027, 0.023056, 0.041806, 0.009723, -0.031111, 0.012639, -0.009861, -0.085694, -0.148611, -0.029444
x_count = 21
y_count = 23
mesh_x_pps = 5
mesh_y_pps = 5
algo = bicubic
tension = 0.2
min_x = 0.0
max_x = 321.0
min_y = 0.0
max_y = 299.85999999999996



# [bed_mesh pei_old]
# version = 1
# points =
# 	  0.024167, 0.023333, 0.004583, 0.014583, 0.001250, 0.031667, 0.004167, -0.010833, -0.012917, -0.012083, 0.024583, -0.029167, 0.006250, -0.000000, -0.023333, -0.041250, -0.011667, -0.033750, -0.045000, -0.078750, -0.107083
# 	  0.058333, 0.015000, -0.001250, -0.002917, -0.005833, -0.010417, -0.017500, -0.026250, -0.010417, 0.004167, -0.008750, -0.019583, -0.016667, 0.000417, -0.005833, 0.002083, -0.004167, -0.030000, -0.038750, -0.071250, -0.065417
# 	  0.015417, -0.000000, -0.017500, -0.022083, 0.021667, -0.012083, -0.022083, -0.031250, -0.007917, -0.018333, -0.004583, -0.030000, -0.030417, -0.019583, -0.015000, 0.009583, -0.010417, -0.007083, -0.037500, -0.072917, -0.076250
# 	  0.002083, -0.022500, -0.035000, -0.046667, -0.029583, -0.041667, -0.011250, -0.016667, -0.010417, -0.009167, 0.021250, -0.033750, -0.030833, -0.002083, 0.025833, 0.035000, 0.015000, 0.007500, -0.023750, -0.055417, -0.054167
# 	  0.010000, -0.014167, -0.051667, -0.042917, -0.023333, -0.060833, -0.003333, -0.060417, -0.008750, -0.042917, -0.028333, -0.021250, -0.040833, -0.000833, -0.003750, 0.012917, -0.010000, -0.022917, -0.030417, -0.055833, -0.063333
# 	  0.019167, -0.020417, -0.043333, -0.058750, -0.040417, -0.040417, -0.020833, -0.059167, -0.049583, -0.041667, -0.039167, -0.024167, -0.032500, -0.006250, 0.002500, -0.000417, 0.002083, 0.003750, -0.016250, -0.036667, -0.021667
# 	  0.035417, -0.007917, -0.015000, -0.006250, -0.040000, -0.047500, -0.032083, -0.058750, -0.042083, -0.043333, -0.031667, -0.025833, -0.022083, -0.001667, -0.000417, 0.013333, -0.002917, 0.024167, 0.015833, -0.025417, -0.047917
# 	  0.017500, -0.012083, 0.002917, -0.050000, -0.060000, -0.061250, -0.068750, -0.074167, -0.048333, -0.045833, -0.030833, -0.027083, -0.028333, -0.006250, -0.000000, 0.005417, 0.007083, -0.010833, -0.021667, -0.042500, -0.025833
# 	  0.019167, -0.012917, -0.015417, -0.060417, -0.055833, -0.070833, -0.056250, -0.037500, -0.055833, -0.050417, -0.043333, -0.030833, -0.028750, 0.022917, -0.000833, -0.008333, -0.009167, -0.010000, -0.038333, -0.048333, -0.052500
# 	  0.013333, -0.018333, -0.053333, -0.065000, -0.065417, -0.074167, -0.078333, -0.034583, -0.035417, -0.038750, -0.022500, -0.004167, -0.026250, -0.009167, -0.010833, -0.001667, -0.011667, -0.015833, -0.037083, -0.060833, -0.065833
# 	  0.035833, -0.012083, -0.038750, -0.049583, -0.068333, -0.050833, -0.082083, -0.095417, -0.027083, -0.058333, -0.045417, -0.012500, -0.031250, 0.037917, -0.005000, -0.001667, 0.029583, -0.026667, -0.013333, -0.072500, -0.005000
# 	  0.023750, -0.015417, -0.017917, -0.050833, -0.073333, -0.065833, -0.099583, -0.086250, -0.066667, -0.055417, -0.022500, 0.000000, -0.025000, 0.000417, 0.004167, 0.000833, 0.013333, -0.023333, -0.033333, -0.035833, -0.061250
# 	  0.045000, -0.001250, -0.042083, -0.069583, -0.057083, -0.100000, -0.066667, -0.085417, -0.072083, -0.017500, -0.050000, -0.035000, -0.033333, -0.009583, 0.003333, -0.003750, -0.019167, -0.005833, -0.026250, -0.064583, -0.081667
# 	  0.033333, 0.011667, -0.048333, -0.074167, -0.077500, -0.088333, -0.090833, -0.095833, -0.070417, -0.060000, -0.055000, -0.028333, -0.036667, 0.006667, -0.008750, -0.003333, -0.010417, -0.037083, -0.040833, -0.020000, -0.071250
# 	  0.063750, -0.011667, -0.045000, -0.071250, -0.069583, -0.068750, -0.067083, -0.097083, -0.074583, -0.057917, -0.051667, -0.022083, -0.044583, -0.012917, -0.016667, -0.020417, -0.018333, -0.025833, -0.042500, -0.055000, -0.065833
# 	  0.032500, -0.002500, -0.045833, -0.028333, -0.062917, -0.080833, -0.079167, -0.093750, -0.072917, -0.055417, -0.041667, -0.026250, -0.023750, 0.005833, -0.000417, 0.042083, 0.000833, -0.006250, -0.001250, -0.038333, -0.051667
# 	  0.079583, 0.018333, -0.016667, -0.064583, -0.069583, -0.090833, -0.051250, -0.102917, -0.073750, -0.056667, -0.041250, -0.026667, -0.045417, -0.013333, 0.002083, -0.014583, -0.013333, -0.026250, -0.025000, -0.043333, -0.050833
# 	  0.045000, 0.015417, -0.045000, -0.065833, -0.042917, -0.083750, -0.077500, -0.071250, -0.032917, -0.045000, -0.000833, -0.023333, -0.026667, 0.001250, 0.011667, 0.012500, -0.005833, -0.029583, -0.024583, -0.045417, -0.042917
# 	  0.098750, -0.012083, -0.051250, -0.067083, -0.054583, -0.060000, -0.089583, -0.087083, -0.061667, -0.042083, -0.028333, -0.026250, -0.028750, -0.006250, 0.001250, 0.041250, 0.037917, 0.000000, -0.023333, -0.041667, -0.047917
# 	  0.028333, 0.019583, -0.066667, -0.087500, -0.085833, -0.100000, -0.061667, -0.087083, -0.070417, -0.044583, -0.051250, -0.036667, -0.038333, -0.025000, -0.007500, -0.023750, -0.027500, -0.037083, -0.030417, -0.051667, -0.072500
# 	  0.040417, -0.022083, -0.023750, -0.099583, -0.099583, -0.111250, -0.095417, -0.106250, -0.080417, -0.067083, -0.050417, -0.051250, -0.050833, -0.039583, -0.007917, -0.002500, -0.045000, -0.057083, -0.060000, -0.078333, -0.090417
# 	  0.008750, -0.027500, -0.045000, -0.092917, -0.090417, -0.107500, -0.108750, -0.093333, -0.076250, -0.048750, -0.053333, -0.059583, -0.059583, -0.052917, -0.045833, -0.036250, -0.056250, -0.073750, -0.051250, -0.088750, -0.092917
# 	  0.070000, 0.016667, -0.059167, -0.082917, -0.085833, -0.094583, -0.097917, -0.050417, -0.064167, -0.061250, -0.045417, -0.050833, -0.065833, -0.033750, -0.039583, -0.031667, -0.055000, -0.045000, -0.090417, -0.106250, -0.105833
# x_count = 21
# y_count = 23
# mesh_x_pps = 5
# mesh_y_pps = 5
# algo = bicubic
# tension = 0.2
# min_x = 15.0
# max_x = 315.0
# min_y = 15.0
# max_y = 345.0



[screws_tilt_adjust]
screw1: 72, 62
screw1_name: front left screw
screw2: 340, 62
screw2_name: front right screw
screw3: 340, 321
screw3_name: rear right screw
screw4: 72, 321
screw4_name: rear left screw
speed: 200
horizontal_move_z: 5
screw_thread: CW-M3

[z_tilt]
# A list of X,Y coordinates (one per line; subsequent lines
# indented) describing the location of each bed "pivot point". The
# "pivot point" is the point where the bed attaches to the given Z
# stepper. It is described using nozzle coordinates (the XY position
# of the nozzle if it could move directly above the point). The
# first entry corresponds to stepper_z, the second to stepper_z1,
# the third to stepper_z2, etc. This parameter must be provided.
z_positions: 378.4,190
  -18.4,190
# A list of X,Y coordinates (one per line; subsequent lines
# indented) that should be probed during a Z_TILT_ADJUST command.
# Specify coordinates of the nozzle and be sure the probe is above
# the bed at the given nozzle coordinates. This parameter must be
# provided.
# points: 360,190
#   72,190
points: 340,62
  72,62
speed: 250


horizontal_move_z: 10
# Number of times to retry if the probed points aren't within
# tolerance.
retries: 10
# If retries are enabled then retry if largest and smallest probed
# points differ more than retry_tolerance. Note the smallest unit of
# change here would be a single step. However if you are probing
# more points than steppers then you will likely have a fixed
# minimum value for the range of probed points which you can learn
retry_tolerance: 0.005

#-------------------------------------
# Fans and temp sensors
#-------------------------------------
# [temperature_sensor stepper_motor_x]
# # measuring the temperature of the X motor
# sensor_type: EPCOS 100K B57560G104F # Creality bed thermistor
# sensor_pin: PA3 # TH2

# [temperature_sensor stepper_motor_y]
# # measuring the temperature of the Y motor
# sensor_type: EPCOS 100K B57560G104F # Creality bed thermistor
# sensor_pin: PA4 # TH3

[multi_pin part_cooler_fans]
pins: PF9, PF6

[fan]
pin: multi_pin:part_cooler_fans
max_power: 1.0
# cycle_time: 0.0001
hardware_pwm: false
# kick_start_time: 0
off_below: 0.05

[heater_fan hotend_fan]
pin: PF7 # FAN0 ==> 24V 
max_power: 1.0
fan_speed: 1.0
kick_start_time: 0
heater: extruder
heater_temp: 50.0

[controller_fan case_fan]
pin: PA4 # FAN3 ==> 24V
heater: heater_bed 

# All steppers (default)
#stepper:

# tachometer_pin: PC15 # FAN6
max_power: 1.0
fan_speed: 1.0
kick_start_time: 0


[adxl345]
#spi_bus: spi1
#spi_speed: 500000
cs_pin: PA15
spi_software_sclk_pin: PC10
spi_software_mosi_pin: PC12
spi_software_miso_pin: PC11

#-------------------------------------
# General
#-------------------------------------


# [force_move]
# enable_force_move: true

# This is the configuration for the original filament sensor
# [filament_switch_sensor filament_sensor]
# switch_pin: PC0 # M4-STOP

[virtual_sdcard]
path: ~/printer_data/gcodes
[display_status]
[pause_resume]
[exclude_object]

# [filament_switch_sensor switch_sensor]
# switch_pin: ^PC1 # M5-STOP
# pause_on_runout: False
# runout_gcode:
#  PAUSE # [pause_resume] is required in printer.cfg
#  M117 Filament switch runout
# insert_gcode:
#  M117 Filament switch inserted

# [filament_motion_sensor encoder_sensor]
# switch_pin: ^PC2 # M6-STOP
# # detection_length: 2.88 # accuracy of motion sensor 2.88mm
# detection_length: 3 # accuracy of motion sensor 3mm as per advice from the manual
# extruder: extruder
# pause_on_runout: False
# runout_gcode:
#  PAUSE # [pause_resume] is required in printer.cfg
#  M117 Filament encoder runout
# insert_gcode:
#  M117 Filament encoder inserted

[stepper_x]
position_min: 0
position_endstop: 340
position_max: 340
step_pin: PE6     # M1
dir_pin: !PE5      # M1
enable_pin: !PC14 # M1
# rotation_distance: 40 # Default
#rotation_distance: 39.6555  # Measured using dial gauge
#rotation_distance: 39.8835 # Calibrated using calibration cube
#rotation_distance: 39.7638 # Calibrated using calibration cube (after reducing flow)
rotation_distance: 39.7539 # Calibrated using calibration cube (after reducing flow)
full_steps_per_rotation: 200
microsteps: 16
#steps per mm = 80
endstop_pin: ^PF4 # M1-STOP
homing_speed: 125

[stepper_y]
position_min: 0
position_endstop: 350
position_max: 350
step_pin: PE2   # M2
dir_pin: !PE1   # M2
enable_pin: !PE4 # M2
# rotation_distance: 40 # Default
# rotation_distance: 39.547 # Measured using dial gauge
#rotation_distance: 39.8733 # Calibrated using calibration cube
rotation_distance: 39.7138 # Calibrated using calibration cube (after reducing flow)


#full_steps_per_rotation: 200
microsteps: 16
#microsteps: 128
endstop_pin: ^PF3 # M2-STOP
homing_speed: 125

[stepper_z]
step_pin: PB8     # M3
dir_pin: !PB7     # M3
enable_pin: !PE0 # M3
rotation_distance: 4 
full_steps_per_rotation: 200
microsteps: 16
endstop_pin: probe:z_virtual_endstop
position_min: -5
position_max: 400
homing_speed: 20.0

[stepper_z1]
step_pin: PB4    # M4
dir_pin: !PB3     # M4
enable_pin: !PB6 # M4
rotation_distance: 4 
full_steps_per_rotation: 200
microsteps: 16


# ---------- X Stepper ----------
# Creality 42-34, 0.8A peak RMS (per phase)
# -------------------------------
[tmc2209 stepper_x]
uart_pin: PC13 # M1-CS
interpolate: false
sense_resistor: 0.110
run_current: 0.7
stealthchop_threshold: 999999

# ---------- Y Stepper ----------
# Creality 42-48, 1.0A peak RMS (per phase)
# -------------------------------
[tmc2209 stepper_y]
uart_pin: PE3 # M2-CS
interpolate: false
sense_resistor: 0.110
#run_current: 0.707
run_current: 0.9
stealthchop_threshold: 175
#stealthchop_threshold: 0

# ---------- Z Stepper ----------
# Creality 42-34, 0.8A peak RMS (per phase)
# -------------------------------
[tmc2209 stepper_z]
uart_pin: PB9 # M3-CS
interpolate: false
sense_resistor: 0.110
run_current: 0.6
# run_current: 0.48
stealthchop_threshold: 999999

[tmc2209 stepper_z1]
uart_pin: PB5 # M4-CS
interpolate: false
sense_resistor: 0.110
run_current: 0.6
# run_current: 0.48
stealthchop_threshold: 999999


[tmc2209 extruder]
uart_pin: PC6 # M8-CS/UART_TX
interpolate: false
run_current: 0.60
stealthchop_threshold: 999999


[firmware_retraction]
retract_length: 0.4
retract_speed: 35
unretract_extra_length: 0
unretract_speed: 25


#-------------------------------------
# Additional Macros
#-------------------------------------

[pause_resume]
[respond]

[gcode_macro _START_PRINT]
gcode:
  {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
  {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}
  {% set STANDBY_TEMP = params.STANDBY_TEMP|default(-1)|float %}
  {% set RETRACT_LENGTH = params.RETRACT_LENGTH|default(0.4)|float %}
  {% set RETRACT_SPEED = params.RETRACT_SPEED|default(35)|float %}
  {% set UNRETRACT_EXTRA_LENGTH = params.UNRETRACT_EXTRA_LENGTH|default(0)|float %}
  {% set UNRETRACT_SPEED = params.UNRETRACT_SPEED|default(25)|float %}
  
  {% set STANDBY_TEMP = params.STANDBY_TEMP|default(-1)|float %}

  # Set default standby temperature to 75% of the target temperature, rounded to the nearest 5 degrees
  {% if STANDBY_TEMP == -1 %}
    {% set STANDBY_TEMP = ((EXTRUDER_TEMP * 0.75 / 5)|round|int) * 5 %}
  {% endif %}

  CLEAR_PAUSE

  # Start bed heating and keep going
  M140 S{BED_TEMP}
  # Set nozzle to standby temperature and keep going
  M104 S{STANDBY_TEMP}
  # Use absolute coordinates
  G90
  # Reset the G-Code Z offset (adjust Z offset if needed)
  #SET_GCODE_OFFSET Z=0.0
  # Home the printer

  # Wait for bed to reach temperature
  M190 S{BED_TEMP}
  # Set hotend temperature
  M104 S{EXTRUDER_TEMP}

  {% if 'z' not in printer.toolhead.homed_axes %} 
  	G28
  {% endif %}  

  BED_MESH_PROFILE LOAD="pei"
  SET_RETRACTION RETRACT_LENGTH={RETRACT_LENGTH} RETRACT_SPEED={RETRACT_SPEED} UNRETRACT_EXTRA_LENGTH={UNRETRACT_EXTRA_LENGTH} UNRETRACT_SPEED={UNRETRACT_SPEED}
	G1 F10500
	G92 E0 ;Reset Extruder
	G1 Z2.0 ;Move Z Axis up
	G1 X10.1 Y20 Z0.28 ;Move to start position

  # Set and wait for nozzle to reach temperature
  M109 S{EXTRUDER_TEMP}

	G1 X10.1 Y200.0 Z0.28 F1500.0 E15 ;Draw the first line
	G1 X10.4 Y200.0 Z0.28 F5000.0 ;Move to side a little
	G1 X10.4 Y20 Z0.28 F1500.0 E30 ;Draw the second line
	G92 E0 ;Reset Extruder
	G1 F10500
	G1 Z2.0 ;Move Z Axis up


[gcode_macro _END_PRINT]
gcode:
  # Turn off bed, extruder, and fan
  M140 S0
  M104 S0
  M106 S0

  # Move nozzle away from print while retracting
  G91
  G1 X-2 Y-2 E-3 F300
  # Raise nozzle by 10mm
	G1 F10500
  G1 Z10
  G90

	G1 X360 Y360

  # Disable steppers
  M84

[gcode_macro SAFE_MOVE]
description: Helper: Safely move to xyz position
gcode:
  {% set x = params.X|default(10)|float %}
  {% set y = params.Y|default(10)|float %}
  {% set z = params.Z|default(10)|float %}
  {% set z_hop_delta = 5.0 %}
  
  ##### calculate safe lift position #####
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}

  {% if act_z + z_hop_delta < z %}
    {% set z_safe = z - act_z %}
  {% elif act_z < (max_z - z_hop_delta) %}
    {% set z_safe = z_hop_delta %}
  {% else %}
    {% set z_safe = max_z - act_z %}
  {% endif %}

  {% if "xyz" not in printer.toolhead.homed_axes %}
    {action_respond_info("Printer not homed")}
  {% else %}
    SAVE_GCODE_STATE NAME=safe_move_state
    G91
    G1 Z{z_safe} F1200
    G90
    G1 X{x} Y{y} F12000
    G1 Z{z} F1200
    RESTORE_GCODE_STATE NAME=safe_move_state
  {% endif %}



[gcode_macro _TOOLHEAD_PARK_PAUSE_CANCEL]
description: Helper: park toolhead used in PAUSE and CANCEL_PRINT
variable_extrude: 0.8
gcode:
  ##### set park positon for x and y #####
  {% set x_park = params.X|default(10)|float %}
  {% set y_park = params.Y|default(10)|float %}
  {% set z_park = params.Z|default(100)|float %}

  ##### end of definitions #####
  {% if printer.extruder.can_extrude|lower == 'true' %}
    SAVE_GCODE_STATE NAME=park_state
    M83
    G1 E-{extrude} F2100
    RESTORE_GCODE_STATE NAME=park_state
  {% else %}
    RESPOND MSG="Extruder not hot enough to retract"
  {% endif %}
  SAFE_MOVE X={x_park} Y={y_park} Z={z_park}


[gcode_macro SHOW_PROMT_BUTTON_GROUPS]
gcode:
    RESPOND TYPE=command MSG="action:prompt_begin MacroPrompt"
    RESPOND TYPE=command MSG="action:prompt_text These are all button colors"
    RESPOND TYPE=command MSG="action:prompt_button default|TEST"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button primary|TEST|primary"
    RESPOND TYPE=command MSG="action:prompt_button secondary|TEST|secondary"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button info|TEST|info"
    RESPOND TYPE=command MSG="action:prompt_button warning|TEST|warning"
    RESPOND TYPE=command MSG="action:prompt_button error|TEST|error"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_show"


[gcode_macro PARK_TOOLHEAD]
description: Helper: Park toolhead
gcode:
  {% if 'xyz' not in printer.toolhead.homed_axes %} 
    RESPOND TYPE=command MSG="action:prompt_begin MacroPrompt"
    RESPOND TYPE=command MSG="action:prompt_text Printer not homed"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG='action:prompt_button Home and park|_HOME_AND_PARK_TOOLHEAD|primary'
    RESPOND TYPE=command MSG="action:prompt_button Cancel|RESPOND TYPE=command MSG=action:prompt_end|secondary"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_show"
  {% else %}
    _TOOLHEAD_PARK_PAUSE_CANCEL
  {% endif %}

[gcode_macro _HOME_AND_PARK_TOOLHEAD]
description: Helper: Park toolhead
gcode:
  RESPOND TYPE=command MSG="action:prompt_end"
  G28
  _TOOLHEAD_PARK_PAUSE_CANCEL


[gcode_macro SERVICE_PARK_TOOLHEAD]
description: Helper: Park toolhead
gcode:
  {% if 'xyz' not in printer.toolhead.homed_axes %} 
    RESPOND TYPE=command MSG="action:prompt_begin MacroPrompt"
    RESPOND TYPE=command MSG="action:prompt_text Printer not homed"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG='action:prompt_button Home and park|_HOME_AND_SERVICE_PARK_TOOLHEAD|primary'
    RESPOND TYPE=command MSG="action:prompt_button Cancel|RESPOND TYPE=command MSG=action:prompt_end|secondary"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_show"
  {% else %}
      _SERVICE_PARK_TOOLHEAD
  {% endif %}


[gcode_macro _HOME_AND_SERVICE_PARK_TOOLHEAD]
description: Helper: Service Park toolhead
gcode:
  RESPOND TYPE=command MSG="action:prompt_end"
  G28
  _SERVICE_PARK_TOOLHEAD


[gcode_macro _SERVICE_PARK_TOOLHEAD]
description: Helper: Center the toolhead to its home position or home if needed
gcode:
  {% set center_x = params.X|default(110)|float %}
  {% set center_y = params.Y|default(140)|float %}
  {% set center_z = params.Z|default(100)|float %}

  {% if 'xyz' not in printer.toolhead.homed_axes %} 
  	G28
  {% else %}
    SAFE_MOVE X={center_x} Y={center_y} Z={center_z}
  {% endif %}


[gcode_macro CENTER_TOOLHEAD]
description: Helper: Center the toolhead to its home position or home if needed
gcode:
  {% set center_x = params.X|default(170)|float %}
  {% set center_y = params.Y|default(175)|float %}
  {% set center_z = params.Z|default(10)|float %}

  {% if 'xyz' not in printer.toolhead.homed_axes %} 
  	G28
  {% else %}
    SAFE_MOVE X={center_x} Y={center_y} Z={center_z}
  {% endif %}

[gcode_macro DISMISS_TOOLHEAD]
description: Helper: Center the toolhead to its home position or home if needed
gcode:
  {% set x_dismiss = printer.toolhead.axis_maximum.x|float - 2.0 %}
  {% set y_dismiss = printer.toolhead.axis_maximum.y|float - 2.0 %}
  {% set z_dismiss = params.Z|default(10)|float %}

  {% if 'xyz' not in printer.toolhead.homed_axes %} 
    RESPOND MSG="Printer not homed"
  {% else %}
    SAFE_MOVE X={x_dismiss} Y={y_dismiss} Z={z_dismiss}
  {% endif %}


[gcode_macro EXTRUDE_TEST]
# Can accurately extrude at at least 300mm/min (5mm/s) but safest to test at 60mm/min (1mm/s)
gcode:
  {% set E = params.E|default(110)|float %}
  {% set F = params.F|default(60)|float %}
  G91
  G1 E{E} F{F}
  G90

[gcode_macro LOAD_FILAMENT]
variable_slow_load_speed:  10
variable_slow_load_distance:  35
variable_fast_load_speed:  15
variable_fast_load_distance:  30
gcode:
  SAVE_GCODE_STATE NAME=load_state
  G91
  G92 E0
  G1 E{slow_load_distance} F{slow_load_speed * 60} # fast-load
  G1 E{fast_load_distance} F{fast_load_speed * 60} # fast-load
  RESTORE_GCODE_STATE NAME=load_state
  PURGE_FILAMENT

[gcode_macro PURGE_FILAMENT]
variable_purge_speed:  5
variable_purge_distance: 50
gcode:
  SAVE_GCODE_STATE NAME=purge_state
  G91
  G92 E0
  G1 E{purge_distance} F{purge_speed * 60} # purge
  RESTORE_GCODE_STATE NAME=purge_state



[gcode_macro HOT_HOME_RETILT]
gcode:
  {% set REHEAT_THRESHOLD = params.REHEAT_THRESHOLD|default(4)|float %}
  {% set BED_TEMP = params.BED_TEMP|default(60)|float %}

  RESPOND MSG="Waiting for bed to reach {BED_TEMP + REHEAT_THRESHOLD / 2}C"
  M190 S{BED_TEMP + REHEAT_THRESHOLD / 2}
  SET_HOMING_HEATERS THRESHOLD={REHEAT_THRESHOLD}

  {% if 'z' not in printer.toolhead.homed_axes %} 
  	G28
  {% endif %}
  Z_TILT_ADJUST
  G28
  SET_HOMING_HEATERS
  # Start bed heating to original temp and keep going
  M140 S{BED_TEMP}



[gcode_macro HEATED_BED_MESH]
gcode:
  {% set REHEAT_THRESHOLD = params.REHEAT_THRESHOLD|default(4)|float %}
  {% set BED_TEMP = params.BED_TEMP|default(60)|float %}

  RESPOND MSG="Waiting for bed to reach {BED_TEMP + REHEAT_THRESHOLD / 2}C"
  M190 S{BED_TEMP + REHEAT_THRESHOLD / 2}
  SET_HOMING_HEATERS THRESHOLD={REHEAT_THRESHOLD}

  # Make sure we are homed while the bed is hot
  G28
  BED_MESH_CALIBRATE
  SAVE_CONFIG


[delayed_gcode Home_XYZ_and_heat]
initial_duration: 1
gcode:
  M140 S60
  # Re-enable when I have a UPS
  #G28



# All the below macros are from: https://klipperscreen.readthedocs.io/en/latest/macros/#load_filament-unload_filament

[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
gcode:
  PAUSE_BASE
  _TOOLHEAD_PARK_PAUSE_CANCEL


[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
  ##### read extrude from  _TOOLHEAD_PARK_PAUSE_CANCEL  macro #####

  {% set extrude = printer['gcode_macro _TOOLHEAD_PARK_PAUSE_CANCEL'].extrude %}
  #### get VELOCITY parameter if specified ####
  {% if 'VELOCITY' in params|upper %}
    {% set get_params = ('VELOCITY=' + params.VELOCITY)  %}
  {%else %}
    {% set get_params = "" %}
  {% endif %}
  ##### end of definitions #####
  {% if printer.extruder.can_extrude|lower == 'true' %}
    M83
    G1 E{extrude} F2100
    {% if printer.gcode_move.absolute_extrude |lower == 'true' %} M82 {% endif %}
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}

  RESUME_BASE {get_params}

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
variable_park: True
gcode:
  ## Move head and retract only if not already in the pause state and park set to true

  {% if park|lower == 'true'%}
    {% if printer.pause_resume.is_paused|lower == 'true' %}
      _TOOLHEAD_PARK_PAUSE_CANCEL
    {% else %}
      DISMISS_TOOLHEAD
    {% endif %}
  {% endif %}

  #TURN_OFF_HEATERS
  # Leave on the bed heater
  M104 S0
  M106 S0

  CANCEL_PRINT_BASE

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.013056, -0.003611, 0.034723, 0.051806, 0.013473, -0.024027, -0.011527, 0.097639, 0.110139, 0.070973, 0.035139, 0.073473, 0.075139, 0.083889, -0.003611, -0.009861, -0.001111, -0.058194, -0.095277, -0.158194, -0.053611
#*# 	  0.009723, -0.006111, -0.013611, 0.071389, 0.052639, -0.005277, 0.067223, 0.099723, 0.119723, 0.088056, -0.036111, 0.066389, 0.092639, 0.086389, 0.059723, 0.066806, 0.057223, -0.042777, -0.091944, -0.111527, 0.023056
#*# 	  0.044306, -0.032361, -0.044027, 0.087639, 0.109306, 0.008889, 0.061389, 0.105556, 0.068889, 0.034306, -0.025277, 0.008473, 0.045973, 0.065556, 0.011806, -0.020694, -0.006111, -0.035277, -0.064861, -0.084444, 0.001806
#*# 	  -0.019861, -0.076944, -0.043194, -0.011944, -0.019444, -0.058194, -0.052777, -0.001527, -0.013194, -0.003194, -0.061527, -0.034861, 0.000139, 0.068473, 0.007639, -0.013611, 0.084306, -0.015277, -0.036527, -0.068194, 0.088889
#*# 	  -0.012777, -0.057777, -0.049444, 0.004306, -0.034027, -0.038194, -0.054444, 0.022223, 0.014306, -0.012361, -0.059027, -0.009861, 0.023056, 0.011806, -0.015694, -0.009444, -0.006527, -0.026111, -0.049444, -0.066944, 0.085139
#*# 	  -0.008611, -0.061944, -0.051111, -0.026111, -0.016111, -0.054444, -0.043611, -0.008611, -0.011111, -0.013194, -0.034861, -0.007361, 0.024306, 0.063473, -0.014027, 0.006806, 0.017639, -0.008194, -0.029444, -0.070277, 0.065139
#*# 	  0.007223, -0.034027, -0.004861, 0.012223, -0.030277, -0.050277, -0.044444, -0.017361, 0.007223, -0.022361, -0.031944, -0.010277, 0.017639, 0.032223, 0.018473, -0.015277, 0.029723, -0.013194, -0.019861, -0.065694, 0.050973
#*# 	  0.021806, -0.033611, -0.007777, -0.017777, 0.000973, -0.041111, -0.052361, -0.034027, -0.005277, -0.009861, -0.051527, -0.007777, 0.026389, 0.036389, -0.009861, -0.011944, 0.016389, -0.004861, -0.047777, -0.058611, 0.052639
#*# 	  0.037639, 0.012639, 0.003056, -0.003611, -0.016944, -0.058194, -0.047777, -0.027777, -0.026111, -0.016944, -0.037361, -0.003194, 0.016806, 0.026806, -0.017361, -0.005277, 0.018473, -0.005277, -0.034027, -0.078611, 0.020973
#*# 	  0.057223, -0.032777, -0.021111, -0.019444, -0.039027, -0.074027, -0.055277, -0.011111, -0.007777, -0.026944, -0.033194, 0.001389, 0.044306, 0.032639, 0.010139, -0.004444, 0.010556, -0.006527, -0.030277, -0.080694, 0.047223
#*# 	  0.036389, -0.033194, -0.018611, -0.013194, -0.049027, -0.064444, -0.059444, -0.021527, -0.006111, -0.015694, -0.034444, -0.015277, 0.044723, 0.019723, 0.005556, 0.007223, 0.024723, -0.010277, -0.045277, -0.085694, 0.020139
#*# 	  0.070973, -0.009444, 0.008889, 0.002639, -0.022361, -0.049861, -0.043611, 0.012639, 0.005139, -0.006944, -0.034444, 0.002639, 0.056389, 0.048473, 0.019723, 0.010139, 0.021806, -0.019444, -0.056944, -0.076944, 0.011389
#*# 	  0.087639, 0.001389, -0.001944, -0.006944, 0.010139, -0.024444, -0.033611, 0.011806, 0.011389, 0.008056, -0.008194, 0.027639, 0.054306, 0.052639, 0.018473, 0.020556, 0.015973, 0.010139, -0.025694, -0.071944, 0.029723
#*# 	  0.062223, -0.000277, 0.002639, 0.012223, -0.022361, -0.029027, -0.044027, -0.000277, 0.034723, 0.015556, -0.022777, 0.013889, 0.056806, 0.046389, 0.000556, 0.001806, 0.017639, -0.016111, -0.058611, -0.102777, 0.011389
#*# 	  0.083056, 0.024306, 0.024723, 0.007223, -0.024444, -0.046111, -0.035277, -0.001944, -0.003611, 0.016806, -0.039027, -0.000277, 0.057639, 0.038473, 0.011389, -0.003611, 0.019306, -0.018194, -0.040277, -0.117361, -0.002361
#*# 	  0.061806, 0.012639, -0.001111, 0.002223, -0.036111, -0.048611, -0.057361, -0.005694, -0.014444, 0.000556, -0.039444, -0.001111, 0.035556, 0.023056, 0.009306, -0.006527, 0.020973, -0.018611, -0.064444, -0.092777, 0.005973
#*# 	  0.096389, 0.011806, 0.013473, 0.030139, -0.009444, -0.061944, -0.051527, -0.004027, -0.002777, 0.003056, -0.021944, 0.014723, 0.043473, 0.045556, 0.015139, 0.016806, 0.015139, -0.004444, -0.060277, -0.090277, 0.033889
#*# 	  0.098473, 0.014306, 0.012223, -0.013611, -0.035277, -0.071527, -0.069027, -0.025277, -0.004444, -0.005277, -0.037777, 0.005556, 0.037223, 0.030556, 0.000556, -0.023194, 0.017223, 0.001806, -0.049027, -0.109444, 0.017223
#*# 	  0.113473, 0.012223, 0.018473, -0.005277, -0.022361, -0.053611, -0.073194, -0.031111, -0.018194, -0.031111, -0.024444, 0.019306, 0.038473, 0.034723, 0.013889, -0.001527, 0.034306, -0.024444, -0.046111, -0.096944, 0.018889
#*# 	  0.115556, -0.004861, 0.033056, -0.002361, -0.008611, -0.078194, -0.057777, -0.024444, -0.031111, -0.029027, -0.039444, 0.002639, 0.024723, 0.042223, -0.034027, -0.004861, 0.013473, -0.024027, -0.048611, -0.094027, 0.006806
#*# 	  0.107223, 0.034723, 0.011806, 0.015973, 0.009306, -0.069861, -0.072361, -0.018194, 0.062223, 0.005556, -0.045277, -0.021527, 0.027639, 0.012223, -0.019444, -0.036944, -0.011944, -0.037777, -0.072361, -0.112777, -0.005277
#*# 	  0.086389, -0.003194, 0.011389, 0.019723, -0.038194, -0.070694, -0.089861, -0.028194, -0.009444, -0.020277, -0.015694, 0.005556, 0.019306, 0.018056, -0.014027, -0.044444, -0.003611, -0.040277, -0.059027, -0.131527, 0.003473
#*# 	  0.116389, 0.010973, 0.024723, -0.012777, -0.036944, -0.058611, -0.061944, -0.006944, 0.010973, 0.013889, -0.062361, -0.014027, 0.023056, 0.041806, 0.009723, -0.031111, 0.012639, -0.009861, -0.085694, -0.148611, -0.029444
#*# x_count = 21
#*# y_count = 23
#*# mesh_x_pps = 5
#*# mesh_y_pps = 5
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 0.0
#*# max_x = 321.0
#*# min_y = 0.0
#*# max_y = 299.85999999999996
